<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Terminal</title>
    <link rel="icon" type="image/png"
          href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAcCAYAAAAAwr0iAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA0xpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OTgyRjc1RjA3MTZEMTFFNjg2M0NCOEY3RjJBMEY3N0EiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OTgyRjc1RUY3MTZEMTFFNjg2M0NCOEY3RjJBMEY3N0EiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjU3YmQxNjhjLWI5ZDctMTE3OS1hM2RlLWZmNjQyYTM4NTJmMCIgc3RSZWY6ZG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjU3YmQxNjhjLWI5ZDctMTE3OS1hM2RlLWZmNjQyYTM4NTJmMCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PhsssMYAAALDSURBVHjaxFa9jxJBFH8zDMdCYrhIAppgIjaG5C5RQ+zO2Gty5gpbY2KsbOyu1MrGGEtj/A9stLPXs6CjJ5GYIF6AE5IDBHZmfG92F4ZzvQAnyyO7O8zX+73f+5gRd3bvvSgffN4/l948YgASFhQ9aWhqM6+pYfrVjD5WH9NK8f7x8ebNnVtvWC6b/RaPxy8zxsxmbB5lIfNsIDMggreezqG1o9GIGj8E45zFNzYgnU4D5xyUUkBglpFAKfgWa5gFY89rNVvgJJMgSBkpjcViIISA4XAI4/EYkBXTdyYQ9LOUU9sw7bmG2lqgPwwAKSV9D/P5/G2csNtoNJ71+32HFjqOszyQkDY9xLbrjkEorSe+wYGc67o72Wz2dSqV+tjr9e4iiAfdbnfL+G4B10wtDV/nBSYAN5O053eivVqtvq1UKr/RDaVCofCyVCo9ogXE0qISppgsJ3GlCzzGkQHcOEgT8n2xWLyfy+XeDwaDK7Va7Xm73X4YUHaaRfMwcbIPdTNBGWBSwkP3Ewdr9Xr9FcbAUwpICkyKAXuTRdkIAxH4QThOEn61W2YSKruAVpeJiUQiYRQjqHImk9nDjDiPijnO+d7pdN5hXOwRuGXdYRggANIdM9sy2tTeGPsuNpvNJwgkRVUMpYPdV5dJURsIZZ9WBEB6aRhKkeeWSzi2j9kxk8vLFqsABFkvlWSYhoqdni6zY2dRfHJfYoErvxBFLb5expVUDFlYCwDpM8CU0pEDoADUGH9YCf8dgKuQSRagXoo/Lg0Da3CBVwm9syBKBv46FfHNIlc+BYFZQHe0yBnQPgN0HFtV8H8VmXko8ABgEOo1uIDZMbCWALRiQAR/gkvpqsU+Rcl4gW9zR6JLCXXQ5XTVAKR/sqIvGODl89BnJfLHcRJNceP6tQ9fDr4+RmRHmAUqoiLEkOnM1vb2pz8CDACUMgcHE3VMqAAAAABJRU5ErkJggg==">
    <style>body, #terminal {
        position: absolute;
        height: 100%;
        width: 100%;
        margin: 0px;
    }</style>
    <script src="{{ static_url('term/hterm.js') }}" type="text/javascript"></script>
    <script src="{{ static_url('term/sockjs.min.js') }}"></script>
    <script src="{{ static_url('term/sockjs.ext.js') }}"></script>
</head>
<body>
<div id="terminal"></div>
<script>
    (function () {
        var autoReconnect = -1;
        var openWs = function () {
            var termContainer = document.getElementById('terminal');
            var term, pingTimer;
            withSockJS("/term1", function (ws) {
                ws.on("open", function (msg) {
                    pingTimer = setInterval(sendPing, 30 * 1000, ws);
                    ws.emit(
                            "conn",
                            JSON.stringify({
                                "hostname": "{{ h.ip }}",
                                "port": "{{ h.port }}",
                                "username": "{{ h.name }}",
                                "password": "{{ h.password }}"
                            }),
                            function (msg) {
                                console.log(msg);
                            });


                    hterm.defaultStorage = new lib.Storage.Local();
                    hterm.defaultStorage.clear();

                    term = new hterm.Terminal();

                    term.getPrefs().set("send-encoding", "raw");

                    term.onTerminalReady = function () {
                        var io = term.io.push();

                        io.onVTKeystroke = function (str) {
                            ws.emit("data", str);
                        };

                        io.sendString = io.onVTKeystroke;

                        io.onTerminalResize = function (columns, rows) {
                            if (ws.readyState === WebSocket.OPEN) {
                                ws.emit("resize", JSON.stringify({columns: columns, rows: rows}));
                            }
                        };

                        term.installKeyboard();
                    };

                    while (termContainer.firstChild) {
                        termContainer.removeChild(termContainer.firstChild);
                    }
                    term.decorate(termContainer);
                    ws.term = term;
                    console.log("open");
                }).on("error", function (msg) {
                    var errorNode = document.createElement('div');
                    errorNode.style.cssText = [
                        "color: red",
                        "background-color: white",
                        "font-size: x-large",
                        "opacity: 0.75",
                        "text-align: center",
                        "margin: 1em",
                        "padding: 0.2em",
                        "border: 0.1em dotted #ccc"
                    ].join(";");
                    errorNode.textContent = "Websocket handshake failed!";
                    termContainer.appendChild(errorNode);
                    console.log(msg);
                }).on("close", function (msg) {
                    if (ws.term) {
                        ws.term.uninstallKeyboard();
                        setTimeout(function () {
                            ws.term.io.showOverlay("Connection Closed", null);
                        }, 300);
                    }
                    clearInterval(pingTimer);
                    if (autoReconnect > 0) {
                        setTimeout(openWs, autoReconnect * 1000);
                    }
                    console.log(msg);
                }).on("data", function (msg) {
                    term.io.writeUTF16(msg);
                });
            });
        };
        var sendPing = function (ws) {
            ws.emit("ping", "ping");
        };
        openWs();
    })();
</script>
</body>
</html>